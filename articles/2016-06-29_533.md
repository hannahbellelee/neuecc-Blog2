# Japan VR Hackathonに参加し、AMD賞受賞しました

[Japan VR Hackathon](https://vrhackathon.co/)に参加してきました！の[結果が昨日発表](http://mogurapr.hatenablog.com/entry/2016/06/28/235939)されまして、AMD賞(Best Graphics)を受賞しました。やったー。事前に決めた5人チームでの参加で、大賞取る！という気概でやってたので、入選できて良かったです。

今回作ったのは「Clash of Oni Online」というゲームで、[HTC Vive](https://www.htcvive.com/jp/)用のVRゲームです。テーマである"日本らしさ"を（一応）イメージした（一応）和風の装い。

<p class="noindent">
    <iframe width="640" height="360" src="https://www.youtube.com/embed/yUIe2SWPGZo" frameborder="0" allowfullscreen></iframe>
</p>

飛んで来る岩を

<p class="noindent">
<img src="https://cloud.githubusercontent.com/assets/46207/16436948/610a6a4a-3ddd-11e6-804b-8a16cd7493c6.png" />
</p>

吹っ飛ばす

<p class="noindent">
<img src="https://cloud.githubusercontent.com/assets/46207/16436958/72288d02-3ddd-11e6-9bca-d2ca14f18bf9.png" />
</p>

という、VRバッティングセンター。ViveはVRというだけじゃなくてコントローラーがあるのがいいですねー。

今回、2日間 31時間で242コミット（最初のコミットが2016/06/18 09:13で 最後のコミットが 2016/06/19 16:34）。時間制限のなかでは、ちゃんとゲームしてる（ゲーム性的にもとりあえず爽快に全部打ち倒すパターンと一球一球を狙い撃ちしないパターンを用意）し、グラフィックもまぁ見栄えがするレベルで、オンライン協力プレイも実装（ただしデモ時はオフラインモード）したのは結構頑張った。ハッカソン系参加が全員初めての割には綺麗に収められた感あります。

チーム編成と最終的な役割は

* 私（プログラマ）：プロジェクトセットアップ、敵ボス挙動、サーバーセットアップ、エフェクト発注、雑進行管理、プレゼンスライド作成、動画撮影
* プログラマ：マルチプレイプログラム、シーン管理プログラム
* プログラマ：Viveプログラム、エフェクト組み込み
* プログラマ：企画、地形エディット、サウンド、アセット検索、デモ
* テクニカルアーティスト：アセット検索、敵モーション作成、ライティング、エフェクト

という感じでした。全員ほぼViveのプログラミング経験はなし(SDK入れて雰囲気掴んだことはあります程度）

最初に入れたアセットは

* [UniRx](https://github.com/neuecc/UniRx) - ないと無理
* [LINQ to GameObject](https://github.com/neuecc/LINQ-to-GameObject-for-Unity) - ベンリ、だけど今回は別にあまり使わず
* [PhotonWire](https://github.com/neuecc/PhotonWire) - マルチプレイ前提なので。合わせてサーバー側プロジェクトもセットアップ
* [SteamVR Plugin](https://www.assetstore.unity3d.com/jp/#!/content/32647) - Viveがターゲットなので
* [The Lab Renderer](https://www.assetstore.unity3d.com/jp/#!/content/63141) - 使ったことなかったので結局あんま余裕なく使えなかった...

という編成から随時アセット追加追加。

タイムライン
---
1週間ぐらい前に参加を決める。3日前ぐらいに「2人マルチ協力プレイ」「背中合わせにして立ちまわる（時代劇にある格好いい感じのアレ）雑魚戦 + デカい鬼を撃退するボス戦というアクションゲーム」「グラフィックで魅せる」を軸にする。というのを決定。和風です、和風。コミュニケーション手段としてSlack（チャット）を前日に立てる。Unityのバージョンを5.4.0b21に決めて全員にインストールしておいてもらうように。持ち込み物としてHTC Viveを2台用意。当日、会場ついてからGitHub（リポジトリ管理）のPrivateリポジトリを立てて全員招待。

雑魚戦＋ボス戦といっても、作りきれるか怪しいので（実際ボス戦で手一杯だった、そりゃそうだ）、ボス戦から先に作っていくように。最初に決めていた役割分担は

* 私（プログラマ）：マルチプレイ
* プログラマ：ボスプログラム、プレイヤー行動プログラム
* プログラマ：ボスプログラム、プレイヤー行動プログラム
* プログラマ：地形アセット購入/組み込み・サウンド購入/組み込み、パーセプションニューロン触る（使えそうなら使う）
* テクニカルアーティスト：モデルやらモーションやらエフェクトやら

でした。まぁマルチプレイといってもUnity側のプログラムがある程度できないとやることもないんで、まずは自分で持ってきたViveを自前PCのSurface Bookに繋ごうとしたらSurface Bookの出力をViveがうまく認識してくれなくて最終的に諦め（Forumとか見た限りだとノートPCの出力端子とのトラブル事案は結構多い模様なのでshoganaiね)。ということでViveのプログラミングは他の人に完全に任せることにして、ボスのプログラムを作っていこうかなー、ということに。ボス戦は、崖のような場所にボスが立っている（下半身は見せない）というイメージが共有されたので

<p class="noindent">
<img width="640" src="https://cloud.githubusercontent.com/assets/46207/16182516/0484d8f2-36e2-11e6-9f45-813e1915fd4e.gif" />
</p>

迫り来るシリンダー撃退ゲーとして作成。雑に作ったこのシーンは、初日ずっとフル活用されることになったのだった。動画系は常時[GifCam](http://blog.bahraniapps.com/gifcam/)で撮ってSlackにあげてました。イメージが瞬時に共有されますし、良い内容だとテンションも上がりますし。

この時点で[LeanTween](https://www.assetstore.unity3d.com/jp/#!/content/3595)を追加。マルチプレイできるようにするので、非確定要素をいれないように、というのとそんな凝ることもないしなので弾は全部トゥイーンで制御しようかと。トゥイーンライブラリは色々ありますが、今のとこ私が選ぶなら[DOtween](http://dotween.demigiant.com/)かLeanTweenかなぁ。普通だったらDOtween選びます。ただ、今回はLeanTweenにしました、ちょっと慣れておこうかな、と思って。LeanTweenは複数のTweeenの制御とかの補助が入ってないんですが、その辺はUniRxで制御させたので全く問題なし。基本的に完了などのイベントをObservable化すれば既存トゥイーンライブラリとUniRxの統合は容易ですし、かなりいい具合にコントロールできます。実際今回は色々な挙動をそれで組みました。ところで、今ひっそりとUniRx前提のハイパフォーマンスでリアクティブなトゥイーンライブラリを作っているので、それが完成したら基本的にそれしか使いません:) まぁ、というのもあって色々なトゥイーンライブラリを試しているというのもあります。

このシーンをプレイヤー行動プログラム側に渡して、VIVEで弾き返したり防いだりを作ってもらう感じに。パーセプションニューロン触るマンはパーセプションニューロンを触りつつサウンド探しを、テクニカルアーティストはボスのモデル（これ自体は買ったもの）のUnityへのインポートとテクスチャ調整とモーション付けを、私は弾のバリエーションを作ってました。

<p class="noindent">
<img width="640" src="https://cloud.githubusercontent.com/assets/46207/16182927/556a57b6-36e6-11e6-93a1-cedd15ae33b8.gif" /></p>

豪速球を投げ込むバッティングセンター的イメージ。手前で弾が伸びてくるので振りにくい。二者択一（手前のキューブはプレイヤーAとプレイヤーBです、マルチ協力プレイだから！）でどっちに来るか分からないので、なんとなく緊迫感あってゲーム的でもあるよね、ということで最終的なボス行動にも採用。

<p class="noindent">
<img width="640" src="https://cloud.githubusercontent.com/assets/46207/16183060/f90b428a-36e7-11e6-84e6-ce6e6b504536.gif" /></p>

ぶわーっと全方位に出すのが欲しい(VIVEのデモゲームのThe LabにあるXortexという360度シューティングのボス弾のような）というオーダーを受けて。中々いい感じに派手なので、これも採用。

あとはボツ案的な弾を作ったり、その他、この時点ではまだ夢膨らみんぐで、ボスの行動も腕をばちーんと振り下ろしてきてそれを斬撃の連打で防いで弾き返す（協力プレイなので、片方が防いでたらそれに加勢しないとダメ、とか）、などを想定したコードを準備したりAIは少しリッチにしようかな、と[BehaviorTree](https://en.wikipedia.org/wiki/Behavior_tree_(artificial_intelligence,_robotics_and_control))のライブラリ書いてたり（ノードエディタなしの基本的なランタイムだけ）、プレイヤープログラム作るチームは盾で防御する処理（最終的に削られたけれど最初は刀と盾の装備のつもりだった）をやってたら、夜0時。うーむ、時間が過ぎるのは早い。

この辺でさすがに未だにシリンダーとキューブが相手で完成形が全く見えてないのはヤヴァいでしょうということで、シーン統合しましょう祭り。特にテストで大量のアセットを抱えていたマップ作るマンがGitHubに中々Pushできないなどなどトラぶりつつも、2時ぐらいにようやく一段落。マップにモーション付きボスモデル配置して、とりあえず弾を出るようにして、でこんな具合に。

![ezgif com-resize](https://cloud.githubusercontent.com/assets/46207/16183468/219560d2-36ed-11e6-9bb9-ef072178f880.gif)

色々アレですが、しかし中々格好よくてテンションあがりますね！その他プレイヤーのほうも入れこんだりなんなりで床に転がって仮眠とって、朝。キューブにも岩を当てはめてついに出来上がったのは……！

![image](https://cloud.githubusercontent.com/assets/46207/16183503/8739926e-36ed-11e6-8954-ef885f0e3300.png)

んー、悪くない。悪くないんだけど、和ではない。雲南省（適当なイメージ）とかそういう中国の高山っぽい気すらする。ここで実際完成させる仕様を概ね確定。

* マップは明確に和テイストが出るものにリテイク
* ボスは殴り攻撃などなし、弾のみ
* 盾はなし、弾を打ち返してボスにダメージ与えて、一定回数食らわせたらクリア
* マルチプレイは諦めないので作業は並走、ただし最終的にはシングルプレイが完全にプレイできるの優先

私は、ボスのモーションが二種あって、殴りつけてくるつもりでつけてもらったモーションはボスが弾を投げ飛ばしてくる（つもり）な雰囲気に適当に調整（タイミングは適当にdelayかけて目視で合わせただけでジャストとは程遠いんですが、まぁなんとなくそれっぽく見えなくもないのでヨシとした）したり、もう一個の大技っぽくやってくるモーションは、なんか岩を抱え込んでる感じにできそうな気がしたので、適当にそれっぽく位置合わせして破裂させてみることに。

![resize](https://cloud.githubusercontent.com/assets/46207/16183698/f027a2a0-36ef-11e6-9ebc-649b5f76336c.gif)

うん、それっぽい。地面にめり込んでってるのとかも、まぁ全然気にならないし。このボス行動は今回のハッカソンで私的な私が作った中では一番よくやりましたしょうでした。全部、偶然素材が揃っただけなんですがうまく噛み合ったということで。

この後は、マップを和テイストに差し替えて常時マップブラッシュアップ、ゲームの要素が確定したので、各種のヒットエフェクトを作ってもらって当て込みや効果音、プレイ感向上のための弾の動きなどの調整、そして諦めてないマルチプレイなどなどを時間ギリギリまで使ってなんとか完成……！（実際、最後の30分でボスのダメージエフェクトがつき、最後の15分前でボスが死ぬようになった程度にギリギリだった）

マルチプレイに関しては、Viveのセンサーが干渉してうまく二台プレイの調整ができなかったのと、もう一台のデスクトップPCを会場の無線LANに繋げなくて、というネットワーク的な問題で断念。いちおう、プログラム側はマルチ想定で動作するように最後まで組んでました、いやほんと。サーバー側、AzureのVMも一時的なものなのでということで、かなりマシンパワーの強いものに変更したりしたんですけどね、というわけでここをお見せできなかったのは残念。なので、最後の5分でマルチプレイ用のログイン待機処理を消して、リリースビルド完成。お疲れ様ー。

完成形
---
出来上がったものは、マップリテイクによって城が追加されたことにより「城下まで迫ってきた赤鬼を、手に持つサムライブレードにより撃退し、城を守る」という設定に。なっていた。完全後付けで。ゲーム名は特に何も考えもなく直前で「Clash of Oni Online」に大決定。

ハッカソンでの評価は特に会場でのプレゼンはなく、体験してもらって審査員が表を付けてく形式とのことで、あとはデモマンがいい感じに来場者に説明してるのを横目に私は会場を見学する:)最後の一秒までドタバタと調整を続けていた割には、目立ったバグもなくスムースにプレイできてて良かった良かった。

最終的には当日の審査ではなく後日の審査ということなので、プレゼン資料を作ったり動画を撮ったりして

<iframe src="//www.slideshare.net/slideshow/embed_code/key/2PlYr3M2epDy6U" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/neuecc/clash-of-oni-online-vr-multiplay-sword-action" title="Clash of Oni Online - VR Multiplay Sword Action " target="_blank">Clash of Oni Online - VR Multiplay Sword Action </a> </strong> from <strong><a href="//www.slideshare.net/neuecc" target="_blank">Yoshifumi Kawai</a></strong> </div>

結果待ち……！そして発表……！受賞……！やったね！

反省点とか
---
当初の想定よりもViveのルームスケールを活かしてない、直立不動のスタイルになったのは、ちょっと想定外。弾を避けたりとか、近寄ったりとかもうちょっとだけアクティブなのをイメージしていたので、しょうがないといえばしょうがないのだけれど、次に何か作るのだったら動くタイプのを作りたいですねぇ。

効果音が足りなかったり、割れてたり。効果音足りないのは、岩の音を、ボス撃破音とか足すべき箇所はいっぱいですよねー。マップリテイクで時間が取れなかったのがその辺の敗因か。Viveコントローラーと刀の位置が微妙にあってなかったり、足が地面に設置してなかったりといった、プレイヤーに対する調整も甘め。shoganai。この辺はViveプログラミングにて慣れてれば、スッと合わせられる話だと思うので、経験値を積もう。ボスの全方位弾が実は全方位じゃなくて左に寄ってるのは普通にロジックのバグ……。リテイク後のマップのクオリティが急ぎで用意しただけあってリテイク前に比べると低い（雑に光源足すためだけの灯籠を並べるとかしたかった）、ボスを遠方に置く形になってしまったのでスケール感が出なかった、など。

とか、まぁアラはいくらでも見つかりますが、基本的にはよくやったと思ってる……！よ！チームメンバーが全員、より良くするために自分の仕事を探して作りきっていったというのは純粋なハッカソンの楽しさという感じで、疲労困憊だけど達成感はありますね。

それとViveでのプログラミングは、結構ゲーム作成入門(Unity入門)にいいかもですね。3Dのプレイヤーの操作ってモーションつけたり色々ハードル高いですが、Viveならすぐに手の動きがキャプチャされて自由に動かせるアクションが作れるので、よくあるシューティングとかブロック崩しとか作っていくよりも楽しいんじゃないかな。（今のVR経験値が少ない現状なら）VRで空間を見て、Viveコントローラーで自由に操作できるというのは、それだけで楽しい体験を作れちゃいますしね。

そんなわけで、家でもViveを設置したしGeforce GTX 1080搭載PCも買ったので、ちょいちょいとVive用に何か作っていきたいという気持ちを強くしました。ので、ちょいちょいと出していければいいですねー。